# home_assistant компоненты для работы с порталом Мосэнергосбыт (https://www.mosenergosbyt.ru)

Портал Москвы предоставляет возможность передачи данных электричества. Однако, было принято решение сделать отдельный компонент для работы с Мосэнергосбыт, ускорив его работу и сделав данные сенсора более полными.

1. Клонировать репозиторий [https://github.com/kkuryshev/ha_mosportal.git](https://github.com/kkuryshev/ha_mosportal.git)
2. Создать при необходимости папку "custom_components" и в нее скопировать папку "mosenergosbyt" и ее содержимое.
3.  Добавить следующие настройки в основной файл конфигурации HAS "configuration.yaml". 

        mosenergosbyt:
          username: !secret mosenergosbyt_login
          password: !secret mosenergosbyt_passwd
4. Компонент автоматически добавит сенсоры (по одному на каждый счетчик, зарегистрированный в ЛК на портале Мосэнергосбыт). 
   * По умолчанию название счетчика берется из его номера. При желании, название сенсора можно переименовать в Home_assistant (HASS)
   * Счетчики можно так же отключить (в настройках HASS). 
   * Автоматическое получения данных с портала для счетчиков отключено. Обновить состояние можно вручную, вызвав для этого стандартный сервис HAS homeassistant.update_entity и указав в входных данных entity_id = названию сенсора. 
5. Для передачи показаний нужно вызвать сервис **mosenergosbyt.publish_electricity_usage** с следующими параметрами:
   
        paycode: номер ЛС
        volume_day: показания по тарифу 1 (дневной)
        volume_night: показания по тарифу 2 (ночной)
        volume_middle: показания по тарифу 3 (промежуточный)
6. По результатам выполнения сервис сгенериует одно из двух событий (event):
   * В случае, если сервис отработал успешно, будет сгенерировано событие **upload_electricity_success**, которое будет содержать json следующего формата: {msg: строка}
   * В случае, если сервис отработал с ошибой, будет сгенерировано событие **upload_electricity_fail**, которое будет содержать json следующего формата: {msg:строка с ошибкой}
